---
title: "ILS Ceramide Ring Trial Manuscript"
output:
  html_document:
    df_print: paged
  html_notebook:
    code_folding: hide
params:
  run_in_targets: no
---

```{r setup}

if(params$run_in_targets) {
  library(targets)
  library(tarchetypes)
}

library(readr)
library(here)
library(ggbeeswarm)
library(patchwork)
library(glue)
library(ggh4x)
library(fs)
library(tidyverse)

source(here("R/manuscript_functions.R"))

here::i_am("manuscript/manuscript-figures-tables.Rmd")

pos <- ggbeeswarm::position_beeswarm(dodge.width = 0.07, method = "center") 
```


# 01. Data preparation

Outlier filter based on Tukey's 1.5x IQR fences: 1st quantile (Q1) -1.5 × interquartile range (IQR) and 3rd quantile (Q3) + 1.5 × IQR 

```{r dataprep, message=FALSE}

limit_iqr = 1.5

# Import data from the targets pipeline ----

if (params$run_in_targets) {
  print(paste("Running in targets pipeline!"))
  d_orig <- tar_read(nistAveragedConcentrationsFile)
} else {
  print(paste("Running stand-alone!"))
  d_orig <-
    readr::read_csv(file = here("output/nistCal1Cal2AveragedConcentrations.csv"))
}

# Get lab protocols details 

d_protocols <- read_csv(here("data/definitions/LabProtocolDetails_Manuscript.csv"))



# Prepare variable `d_full` containing the full annotated dataset -------------------

d_full <- d_orig |>
  select(
    SampleType,
    ceramideName,
    Protocol,
    Sample,
    replicate,
    LabId,
    MassAnalyzerType,
    RatioLipidToIS,
    C_SinglePoint,
    C_Adj = Avg_C_Adj,
    C_Adj_C16 = Avg_C_Adj_C16,
    C_Adj_C18 = Avg_C_Adj_C18,
    C_Adj_C24 = Avg_C_Adj_C24,
    C_Adj_C241 = Avg_C_Adj_C241
  ) |>
  mutate(ceramideName = str_replace(ceramideName, fixed("d18:1"), "18:1;O2")) |>
  separate(
    LabId,
    into = c("LabId_group", "MethodNo"),
    convert = FALSE,
    remove = FALSE,
    sep = "[abc]",
    fill = "right"
  ) |>
  mutate(
    MethodNo = str_extract(LabId, "[abc]"),
    MethodNo = if_else(is.na(MethodNo), "a", MethodNo),
    Protocol = if_else(Protocol == "Standard", "SOP", "OTHER"),
    SampleType = str_replace(SampleType, "NIST ", ""),
    SampleType = if_else(SampleType == "T1D", "DB", SampleType),
    MassAnalyzerResolution = if_else(MassAnalyzerType == "QQQ", "LowRes", "HighRes")
  ) |>
  left_join(d_protocols |> select(LabId, LC), by = "LabId") |> 
  relocate(LC, MassAnalyzerResolution, .before = MassAnalyzerType) |> 
  group_by(LabId_group) |>
  mutate(LabNum = dplyr::cur_group_id()) |>
  ungroup() |>
  dplyr::distinct()

# Correction of concentrations in dataset #26a/#26b (LabNum 22) as this lab spiked 3x higher internal standard amounts
d_full <- d_full |>
  mutate(
    C_SinglePoint = if_else(LabId %in% c("26a", "26b"), C_SinglePoint * 3, C_SinglePoint),
    C_Adj = if_else(LabId %in% c("26a", "26b"), C_Adj * 3, C_Adj)
  )


d_full$Protocol <- forcats::fct_relevel(d_full$Protocol, c("SOP", "OTHER"))
d_full$LC <- forcats::fct_relevel(d_full$LC, c("RP", "SFC", "FIA"))
d_full$SampleType <- forcats::fct_relevel(d_full$SampleType, c("SRM", "hTAG", "DB", "YAA"))
d_full$MassAnalyzerResolution <- forcats::fct_relevel(d_full$MassAnalyzerResolution, c("LowRes", "HighRes"))


# Prepare variable `d_sample_mean` with injection replicates averaged and calculated corresponding replicate CVs ------

d_sample_mean <- d_full |>
  group_by(
    SampleType,
    ceramideName,
    Sample,
    LabId,
    LabId_group,
    LabNum,
    MethodNo,
    Protocol,
    LC, 
    MassAnalyzerResolution,
    MassAnalyzerType
  ) |>
  dplyr::summarize(
    RatioLipidToIS_mean = mean(RatioLipidToIS, na.rm = TRUE),
    RatioLipidToIS_SD = sd(RatioLipidToIS, na.rm = TRUE),
    RatioLipidToIS_RepCV =  RatioLipidToIS_SD / RatioLipidToIS_mean *
      100,
    RatioLipidToIS_RepCV = if_else(RatioLipidToIS_RepCV == 0, NA_real_, RatioLipidToIS_RepCV),
    C_SinglePoint_mean = mean(C_SinglePoint, na.rm = TRUE),
    C_SinglePoint_SD = sd(C_SinglePoint, na.rm = TRUE),
    C_SinglePoint_RepCV =  C_SinglePoint_SD / C_SinglePoint_mean * 100,
    C_SinglePoint_RepCV = if_else(C_SinglePoint_RepCV == 0, NA_real_, C_SinglePoint_RepCV),
    C_Adj_mean = mean(C_Adj, na.rm = TRUE),
    C_Adj_C16_mean = mean(C_Adj_C16, na.rm = TRUE),
    C_Adj_C18_mean = mean(C_Adj_C18, na.rm = TRUE),
    C_Adj_C24_mean = mean(C_Adj_C24, na.rm = TRUE),
    C_Adj_C241_mean = mean(C_Adj_C241, na.rm = TRUE),
    C_Adj_SD = sd(C_Adj, na.rm = TRUE),
    C_Adj_RepCV =  C_Adj_SD / C_Adj_mean * 100,
    C_Adj_RepCV = if_else(C_Adj_RepCV == 0, NA_real_, C_Adj_RepCV)
  ) |>
  mutate_all( ~ ifelse(is.nan(.), NA, .)) |>
  replace_na(list(
    RatioLipidToIS_SD = 0,
    C_SinglePoint_SD = 0,
    C_Adj_SD = 0
  )) |>
  group_by(LabId_group) |>
  mutate(LabNum = cur_group_id()) |>
  ungroup()


# Prepare variable `d_srm_mean` with sample replicates averaged by SRM and calculated corresponding intra-lab CVs ------

d_srm_mean <- d_sample_mean |>
  group_by(
    SampleType,
    ceramideName,
    LabId,
    LabId_group,
    LabNum,
    MethodNo,
    Protocol,
    LC, 
    MassAnalyzerResolution,
    MassAnalyzerType
  ) |>
  dplyr::summarize(
    RatioLipidToIS_mean = mean(RatioLipidToIS_mean, na.rm = TRUE),
    RatioLipidToIS_sd = sd(RatioLipidToIS_mean, na.rm = TRUE),
    RatioLipidToIS_intralabCV = RatioLipidToIS_sd / RatioLipidToIS_mean *
      100,
    C_SinglePoint_sd = sd(C_SinglePoint_mean, na.rm = TRUE),
    C_SinglePoint_mean = mean(C_SinglePoint_mean, na.rm = TRUE),
    C_SinglePoint_intralabCV = C_SinglePoint_sd / C_SinglePoint_mean *
      100,
    C_Adj_sd = sd(C_Adj_mean, na.rm = TRUE),
    C_Adj_mean = mean(C_Adj_mean, na.rm = TRUE),
    C_Adj_C16_mean = mean(C_Adj_C16_mean, na.rm = TRUE),
    C_Adj_C18_mean = mean(C_Adj_C18_mean, na.rm = TRUE),
    C_Adj_C24_mean = mean(C_Adj_C24_mean, na.rm = TRUE),
    C_Adj_C241_mean = mean(C_Adj_C241_mean, na.rm = TRUE),
    C_Adj_intralabCV = C_Adj_sd / C_Adj_mean * 100
  ) |>
  ungroup() |>
  arrange(SampleType)


# Calculate outlier flags (based on Tukey's 1.5x IQR fences) and prepare outlier filter data subsets ------

## Outlier filtering of single-point calibrated dataset and calculate data summaries
d_srm_mean_filt_sp <- flag_outlier(d_srm_mean, limit_iqr = limit_iqr) |> filter(!Outlier_sp)
d_stat_all_sp <- get_study_stats(d_srm_mean |> filter(SampleType == "SRM"), limit_iqr = limit_iqr)
d_stat_filt_sp <- get_study_stats(d_srm_mean_filt_sp, limit_iqr = limit_iqr)

## Outlier filtering of single-point calibrated dataset and calculate data summaries
d_srm_mean_filt_mp <- flag_outlier(d_srm_mean, limit_iqr = limit_iqr) |> filter(!Outlier_mp)
d_stat_all_mp <- get_study_stats(d_srm_mean, limit_iqr = limit_iqr)
d_stat_filt_mp <- get_study_stats(d_srm_mean_filt_mp, limit_iqr = limit_iqr)


# Save the used mappsing of LabId and LabNo. 
#  LabId is the ID used for data submission and processing within the pipeline, the LabNo 
#  corresponds to renumbered LabIds, which are used in the text and in figures 1 and S2 and in the

d_srm_mean |> select(LabId, LabId_group, LabNum) |> distinct() |>  write_csv(file = here("manuscript/output/LabId-LabNum_mapping.csv"))






```

# 02. Table 1: Analytical methods and platforms. 
SOP refers to the method recommended by the study authors, OTHER to methods chosen by the individual laboratories. The number in brackets indicates the number for each chromatographic/injection method (RP: Reversed Phase, FIA, Flow Injection Analysis, SFC: Supercritical Fluid Chromatography). Other variations present in OTHER may include type of extraction, nano/capLC, LC duration (7-50 min), column chemistries and MS source settings. Platforms: QQQ = triple quadrupole, QTRAP = ion trap, QTOF = quadrupole time-of-flight. 

```{r manuscript-table-1}
d_protocols |> 
  select(LabId, LabNum, Protocol, LC, MassAnalyzerType) |> 
  write_csv(here("manuscript/output/Table1_sourcedata.csv"))
```

# 03. Table 2: Consensus concentrations and CVs of the 4 measured ceramides in the 4 NIST Reference Materials
SOP and OTH refer to the standard and OTHER methods, respectively. n indicates the number of datasets that were included in the calculation of the variables given in this table after removal of outliers of the single-point (SP) or multi-point (MP) calibration, respectively, using Tukey’s 1.5×IQR method (see text). The total number of datasets before removal was 39 (26 SOP/13 OTHER). Intra-lab %CV corresponds to the median of individual intra-lab %CVs. 

```{r manuscript-table-2}


# Table 2 (main text) ------
table2_sp <- d_stat_filt_sp |>
  mutate(n_text = glue::glue("{n} ({n_SOP}/{n-n_SOP})")) |>
  select(
    Matrix = SampleType,
    Ceramide = ceramideName,
    'n (SP)\n(SOP/Others)' = n_text,
    '\U003BCmol/L (SP)\nmean' =  C_SinglePoint_interlabMEAN,
    '\U003BCmol/L (SP)\nSEM' =  C_SinglePoint_interlabSEM,
    'Inter-lab %CV\n(SP)' = C_SinglePoint_interlabCV
  )

table2_mp <- d_stat_filt_mp |>
  mutate(n_text = glue::glue("{n} ({n_SOP}/{n-n_SOP})")) |>
  select(
    Matrix = SampleType,
    Ceramide = ceramideName,
    'n (CAL)\n(SOP/Others)' = n_text,
    '\U003BCmol/L (CAL)\nmean' =  C_Adj_interlabMEAN,
    '\U003BCmol/L (CAL)\nSEM' =  C_Adj_interlabSEM,
    'Inter-lab %CV\n(CAL)' = C_Adj_interlabCV,
    'Intra-lab %CV\n(CAL, median)' = C_Adj_median_intralabCV,
  )

table2_final <- table2_sp |>
  left_join(table2_mp, by = c("Matrix", "Ceramide")) |>
  select(
    "Matrix",
    "Ceramide",
    'n (SP)\n(SOP/Others)',
    'n (CAL)\n(SOP/Others)',
    '\U003BCmol/L (SP)\nmean',
    '\U003BCmol/L (SP)\nSEM',
    '\U003BCmol/L (CAL)\nmean',
    '\U003BCmol/L (CAL)\nSEM',
    'Inter-lab %CV\n(SP)',
    'Inter-lab %CV\n(CAL)',
    'Intra-lab %CV\n(CAL, median)'
  )

write_excel_csv(table2_final, here("manuscript/output/Table2_Consensus-Concentrations-CVs.csv"))
```

# 04. Suppl Table S1: Concentrations and inter-lab %CVs in all reference materials in the full and outlier-filtered datasets
Concentrations and inter-lab %CVs in all reference materials. ALL and Filt correspond to values calculated from the full or the outlier-filtered dataset, respectively. All concentrations were calculated using multi-point calibration. n corresponds to the number of datasets.

```{r manuscript-Suppl_Table-S1}

tableS1_stats_all_datasets <- get_study_stats(d_srm_mean) |>
  select(
    Matrix = SampleType,
    Ceramide = ceramideName,
    'n (All)' = n,
    '\U003BCmol/L (All)\n(mean)' = C_Adj_interlabMEAN,
    '\U003BCmol/L (All)\n(SD)' = C_Adj_interlabSD,
    '\U003BCmol/L (All)\n(median)' = C_Adj_interlabMEDIAN,
    '%CV (All)' = C_Adj_interlabCV,
    '%RCV (All)' = C_Adj_interlabRCV
  )

tableS1_stats_outlierfilt_datasets <- d_stat_filt_mp |>
  select(
    Matrix = SampleType,
    Ceramide = ceramideName,
    'n (Filt)' = n,
    '\U003BCmol/L (Filt)\n(mean)' = C_Adj_interlabMEAN,
    '\U003BCmol/L (Filt)\n(SD)' = C_Adj_interlabSD,
    '\U003BCmol/L (Filt)\n(median)' = C_Adj_interlabMEDIAN,
    '%CV (Filt)' = C_Adj_interlabCV,
    '%RCV (Filt)' = C_Adj_interlabRCV
  )

tableS1_stats_all_datasets |> 
  left_join(tableS1_stats_outlierfilt_datasets) |> 
  write_excel_csv(file = here("manuscript/output/Suppl_TableS1_Concentrations-CVs_ALL-vs-Outlierfilt-datasets.csv"))
```

# 05. Suppl Table S2: Concentrations and inter-lab %CV of ceramide species from the two protocol types
The mean concentrations are given in µmol/L are based on multi-point calibration with outliers removed. The P values are from the comparison of individual values reported by SOP vs OTHER protocols (Welch’s two-sided t-test). n corresponds to the number of datasets after outlier removal.

```{r manuscript-Suppl_Table-S2}

tableS2_stats_part1 <- d_srm_mean_filt_mp |>
  group_by(ceramideName, SampleType) |>
  nest() |>
  mutate(res = purrr::map(data, \(x) broom::tidy(
    t.test(
      C_Adj_mean ~ Protocol,
      var.equal = FALSE,
      alternative = "two.sided",
      data = x
    )
  ))) |>
  unnest(res) |>
  ungroup() |>
  select(SampleType, ceramideName, p.value)

tableS2_stats_part2 <- d_srm_mean_filt_mp |>
  group_by(SampleType, ceramideName) |>
  summarise(
    n_SOP = length(C_Adj_mean[Protocol == "SOP"]),
    n_OTHER = length(C_Adj_mean[Protocol == "OTHER"]),
    mean_SOP = mean(C_Adj_mean[Protocol == "SOP"]),
    mean_OTHER = mean(C_Adj_mean[Protocol == "OTHER"]),
    CV_SOP = sd(C_Adj_mean[Protocol == "SOP"]) / mean_SOP * 100,
    CV_OTHER = sd(C_Adj_mean[Protocol == "OTHER"]) / mean_OTHER * 100
  )

tableS2_final <- tableS2_stats_part2 |>
  left_join(tableS2_stats_part1) |>
  select(
    Matrix = SampleType,
    Ceramide = ceramideName,
    'n\n(SOP)' = n_SOP,
    'n\n(OTHER)' = n_OTHER,
    '\U003BCmol/L\n(SOP)' = mean_SOP,
    '\U003BCmol/L\n(OTHER)' = mean_OTHER,
    'P value' = p.value,
    '%CV\n(SOP)' = CV_SOP,
    '%CV\n(OTHER)' = CV_OTHER
  )

write_excel_csv(
  x = tableS2_final,
  file = here("manuscript/output/Suppl_TableS2_Concentrations-CVs_SOP-vs_OTHER-MP.csv")
)
```

# 06. Suppl Dataset: Concentrations of all species in all samples from all labs (SP and MP) with Outlier status (TRUE/FALSE) ------
```{r manuscript-suppl-dataset}

# create combined table with LC method, MS platform, sample type and lab id, with single and multi-point outlier flags

table_all_data_meanreplicates <- flag_outlier(d_srm_mean, limit_iqr = limit_iqr) |> 
  select(SampleType,
         LabNum,
         LabId,
         ceramideName,
         Protocol,
         LC,
         MassAnalyzerResolution,
         MassAnalyzerType,
         C_SinglePoint_mean,  
         C_Adj_mean,
         Outlier_sp,
         Outlier_mp) |>
  select(
    SampleType, 
    LabNum, 
    LabId, 
    "CeramideName" = ceramideName, 
    Protocol, 
    LC,	
    MassAnalyzerType, 
    MassAnalyzerResolution,	
    "ConcSinglePoint" = C_SinglePoint_mean,	
    Outlier_sp,	
    "ConcMultiPoint" = C_Adj_mean,	
    Outlier_mp
  )

table_all_data_meanreplicates |> 
  select(-ConcMultiPoint:-Outlier_mp) |> 
  rename("Outlier" = Outlier_sp) |> 
  write_excel_csv(here("manuscript/output/Suppl_Dataset_Concentrations_OutlierStatus_Sheet-SinglePointConc.csv"))

table_all_data_meanreplicates |> 
  select(-ConcSinglePoint:-Outlier_sp) |> 
  rename("Outlier" = Outlier_mp) |> 
  write_excel_csv(here("manuscript/output/Suppl_Dataset_Concentrations_OutlierStatus_Sheet-MultiPointConc.csv"))
```

# 07. Figure 1: All samples from all labs

Concentration of the 4 reported ceramides in NIST SRM 1950. Each circle corresponds to one measurement from a vial of NIST SRM 1950 shipped to each of the participating laboratories. Horizontal bars are mean values of the data reported form each participant, while error bars (in some instances) indicate ±1SD of replicate measurements of the same sample. The outer green dotted lines indicate Tukey’s 1st quantile (Q1) - 1.5 × interquartile ranges (IQR) and Q3+1.5 × IQR values used  as cut-off values for outlier removal. The mean and ± 2 × SD (solid grey dashed grey lines) are based on data after outlier removal. Molar concentrations were calculated using the external calibration curve (multi-point calibration). SOP (red) and OTHER (blue) refer to the Standard vs Other methods, respectively.

```{r Fig1-plot, fig.height=8, fig.width=12, out.width="100%"}
p_Fig1 <-
  plot_labscatter(
    d_sample_mean = d_sample_mean,
    d_srm_mean = d_srm_mean,
    labid_col = "LabNum",
    variable = "C_Adj",
    sample_type = "SRM",
    normalisation_sample = NULL,
    excluded_labs = "",
    save_plot = TRUE,
    filename_prefix = "Fig1", 
    as_pdf = TRUE
  )

p_Fig1
```

# 08. Figure 2: Single vs multi-point

Molar concentrations derived from single point internal standard (ISTD) vs. calibration curve-based quantifications. The diagonal line indicates equal results between single point (horizontal axis) and calibration curve-based quantification (vertical axis). Outlier measurements were removed for each ceramide species reference plasma (see Figure 1 and text). NIST SRM 1950 (SRM, blue); hypertriglyceridemic (hTAG, red), diabetic (DB, purple), and African American (YAA, green), which are part of NIST RM 8231.

```{r Fig2-plot, fig.height=5, fig.width=12, out.width="100%"}

plot_single_vs_multipoint <- function(data, xy_lim) {
  p <-
    ggplot(
      data  |> arrange(SampleType) ,
      aes(
        x = C_SinglePoint_mean,
        y = C_Adj_mean,
        color = SampleType,
        fill = SampleType
      )
    ) +
    geom_abline(
      slope = 1,
      intercept = 0,
      color = "#6c9694",
      size = .3,
      linetype = "longdash"
    ) +
    geom_point(
      shape = 21,
      stroke = 0.33,
      size = 1.2,
      alpha = .6
    ) +
    facet_wrap(vars(ceramideName), scales = "free", ncol = 4) +
    #stat_smooth(method = "lm", aes( x = C_SinglePoint, y = C_Adj), inherit.aes = FALSE) +
    scale_x_continuous(limits = c(0, NA)) +
    scale_y_continuous(limits = c(0, NA)) +
    
    labs(x = "\U003BCmol/L (single-point calibration)", y = "\U003BCmol/L (multi-point calibration)") +
    facetted_pos_scales(
      y = list(
        ceramideName == "Cer 18:1;O2/16:0" ~ scale_y_continuous(limits = c(0, xy_lim[1])),
        ceramideName == "Cer 18:1;O2/18:0" ~ scale_y_continuous(limits = c(0, xy_lim[2])),   
        ceramideName == "Cer 18:1;O2/24:0" ~ scale_y_continuous(limits = c(0, xy_lim[3])),
        ceramideName == "Cer 18:1;O2/24:1" ~ scale_y_continuous(limits = c(0, xy_lim[4]))
      ),
      x = list(
        ceramideName == "Cer 18:1;O2/16:0" ~ scale_x_continuous(limits = c(0, xy_lim[1])),
        ceramideName == "Cer 18:1;O2/18:0" ~ scale_x_continuous(limits = c(0, xy_lim[2])),
        ceramideName == "Cer 18:1;O2/24:0" ~ scale_x_continuous(limits = c(0, xy_lim[3])),
        ceramideName == "Cer 18:1;O2/24:1" ~ scale_x_continuous(limits = c(0, xy_lim[4]))
      )
    ) + 
    scale_color_manual(
      values = c(
        "SRM" = "#0571b0",
        "hTAG" = "#ca0020",
        "YAA" = "#92c5de",
        "DB" = "#f4a582"
      ),
      breaks = c('SRM', 'hTAG', 'DB', 'YAA'),
      labels = c('SRM', 'hTAG', 'DB', 'YAA')
    ) +
    scale_fill_manual(
      values = c(
        "SRM" = "#2c7bb6",
        "hTAG" = "#d7191c",
        "YAA" = "#abd9e9",
        "DB" = "#fdae61"
      ),
      breaks = c('SRM', 'hTAG', 'DB', 'YAA'),
      labels = c('SRM', 'hTAG', 'DB', 'YAA')
    ) +
    labs(color = NULL, fill = NULL) +
    #guides(fill = "none") +
    theme_classic( base_size =  9) +  
    #scale_x_discrete(drop = FALSE, expand = expansion(mult = c(.03, .05))) +
    theme(
      axis.text = element_text(size = 7),
      axis.title = element_text(size = 8, face = "bold"),
      #panel.grid.major.x = element_line(colour = "grey70", linewidth = 0.2, linetype = "dotted"),
      strip.background = element_rect(fill = "grey99")
    ) + theme(aspect.ratio = 1) +
    theme(
      legend.position.inside = c(.97, .20),
      legend.key.size = unit(0.1, "cm"),
      legend.text = element_text(size = 6),
      legend.spacing.y = unit(.001, 'cm')
    )
  
    p
}

  d_srm_mean_filt <- flag_outlier(d_srm_mean, limit_iqr = limit_iqr)  |> filter(!Outlier_sp, !Outlier_mp)
  d_srm_mean_filt$SampleType <- forcats::fct_relevel(d_srm_mean_filt$SampleType, c("DB","hTAG","YAA","SRM"))
  
  readr::write_excel_csv(d_srm_mean_filt, file = here(paste0("manuscript/output/Fig2_sourcedata.csv")))
  
  p_Fig2 <- plot_single_vs_multipoint(d_srm_mean_filt, c(0.6, 0.125, 5.5, 1.6))
  ggsave(plot = p_Fig2, filename = here("manuscript/output/Fig2_Comparison_SingleVsMultiCalib-AllDatasets.png"), device = "png",
  dpi = 600, width =160, height =60, units = "mm")
  
  p_Fig2
```

# 09. Figure 3: SRM comparisons

Concentrations of the 4 ceramides in different NIST reference plasma samples. Each circle corresponds to the values reported by one laboratory. P values are based on paired t-tests of complete datasets. The horizontal bars correspond to the mean and ±1 SD of all points per group. SOP (red) and OTHER (blue) refer to the Standard vs Other methods, respectively. Outlier measurements were removed for ceramide species in each reference plasma (see Figure 1 and text). 

```{r Fig3-plot, fig.height=8, fig.width=12, out.width="100%"}

plot_all_refmaterials <- function(data, xy_lim) {
  
  d_sum <- data |> 
    mutate(y_max = max(C_Adj_mean), .by = ceramideName) |> 
    summarise(
      n_labs = paste0("n=",n()), 
      conc_min = min(C_Adj_mean) - mean(y_max)/20,
      .by = c(SampleType, ceramideName)
    )
  
  p <- ggplot(
    data = data,
    mapping = aes(
      x = SampleType,
      y = C_Adj_mean,
      color = Protocol,
      fill = Protocol
    )
  ) +
    ggbeeswarm::geom_beeswarm(
      cex = 2.5,
      size = 1.2,
      stroke = .2,
      method = "swarm",
      priority = "random",
      alpha = .7,
      shape = 21
    ) +  
    stat_summary(
      aes(x = SampleType, y = C_Adj_mean),
      geom = "errorbar",
      inherit.aes = FALSE,
      width = .3,
      color = "darkred",
      linewidth = 0.25,
      alpha = 0.6,
      fun.min = \(x) mean(x) - sd(x),
      fun.max = \(x) mean(x) + sd(x)
    ) +
    stat_summary(
      aes(x = SampleType, y = C_Adj_mean),
      fun = "mean",
      geom = "crossbar",
      inherit.aes = FALSE,
      width = .7,
      color = "darkred",
      linewidth = 0.2,
      alpha = 0.7
    )+
    facet_wrap(vars(ceramideName), ncol = 4, scales = "free") +
    facetted_pos_scales(
        y = list(
          ceramideName == "Cer 18:1;O2/16:0" ~ scale_y_continuous(limits = c(0, xy_lim[1])),
          ceramideName == "Cer 18:1;O2/18:0" ~ scale_y_continuous(limits = c(0, xy_lim[2])),   
          ceramideName == "Cer 18:1;O2/24:0" ~ scale_y_continuous(limits = c(0, xy_lim[3])),
          ceramideName == "Cer 18:1;O2/24:1" ~ scale_y_continuous(limits = c(0, xy_lim[4]))
        )) +
    ggsignif::geom_signif(
      aes(x = SampleType, y = C_Adj_mean),
      inherit.aes = FALSE,
      comparisons = list(c("SRM", "hTAG"), c("SRM", "DB"), c("SRM", "YAA")),
      test = "t.test",
      test.args = list(
        alternative = "two.sided",
        var.equal = FALSE,
        na.action = "ommit"
      ),
      margin_top = 0.05,
      step_increase = 0.07,
      color = "grey30",
      
      size = 0.1 ,
      vjust = 0.1,
      tip_length = 0.01,
      textsize = 1.4,
      map_signif_level = sig_annot
    ) +
    geom_text(
      data = d_sum,
      aes(label = n_labs, x = SampleType , y = conc_min),
      size = 1.3, nudge_x = 0.0,inherit.aes = FALSE, color = "grey70", fontface = "italic"
    ) +
    scale_fill_manual(values = c("SOP" = "#ffc2c2", "OTHER" = "#d1dcff")) +
    scale_color_manual(values = c("SOP" = "#e30202", "OTHER" = "darkblue")) +
    labs(color = NULL, fill = NULL) +
    labs(x = "NIST reference plasma", y = "\U003BCmol/L (multi-point calibration)") +
    theme_classic(base_size = 7) +
    #scale_x_discrete(drop = FALSE, expand = expansion(mult = c(.1, .05))) +
    theme(
      axis.text.x = element_text(size = 6, face = "plain", angle = 0),
      axis.text.y = element_text(size = 6, face = "plain", angle = 0),
      axis.title.x = element_text(
        size = 7,
        face = "bold",
        angle = 0,
        margin = margin(
          t = 8,
          r = 0,
          b = 0,
          l = 0
        )
      ),
      axis.title.y = element_text(
        size = 6,
        face = "bold",
        angle = 90,
        margin = margin(
          t = 0,
          r = 7,
          b = 0,
          l = 8
        )
      )
    ) +
    theme(
      legend.position.inside = c(.97, .07),
      legend.key.size = unit(0.2, "cm"),
      legend.spacing.y = unit(.001, 'cm')
    )
  
  p
}


pos_points <- ggbeeswarm::position_beeswarm(cex = 1, dodge.width = 0.2)
d_srm_mean_filt <- flag_outlier(d_srm_mean, limit_iqr = limit_iqr) |> filter(!Outlier_mp)
d_srm_mean_filt$SampleType <- forcats::fct_relevel(d_srm_mean_filt$SampleType, c("SRM","hTAG","DB","YAA")) 
readr::write_excel_csv(d_srm_mean_filt, file = here(paste0("manuscript/output/Fig3_sourcedata.csv")))

p_Fig3 <- plot_all_refmaterials(d_srm_mean_filt, xy_lim = c(0.45, 0.145, 5.6, 1.9))

ggsave(plot = p_Fig3, filename = here("manuscript/output/Fig3_SRMs_Dotplots.png"), device = "png",
dpi = 600, width = 160, height = 65, units = "mm")

p_Fig3

  d_stat <- d_srm_mean_filt |> 
      group_by(ceramideName, SampleType) |> 
    summarise(
      n_labs = n(),
      MEAN = mean(C_Adj_mean, na.rm = TRUE),
      SD = sd(C_Adj_mean, na.rm = TRUE),
      CV = SD/MEAN *100)  |> 
    ungroup() 
readr::write_excel_csv(d_stat, file = here(paste0("manuscript/output/Fig3_sourcedata_statistics.csv")))

```

# 10. Figure 4: Interlaboratory Study Comparisons

Comparison of inter-laboratory and/or cross-platform trials reporting ceramide concentrations in NIST SRM 1950. Each open circle corresponds to the reported value from one laboratory in each of the respective studies referenced by first author and year of publication. (sp) refers to a single, standardized protocol and platform employed by all laboratories while (mp) denotes studies in which multiple protocols and platforms were used. The red boxes and numbers indicate median ± MAD (mean absolute deviation) and the number of participating laboratories respectively. Depending on the precise nature of the study and/or reporting laboratory, concentrations were either reported with sphingoid-base and fatty details (e.g. Cer 18:1;O2/16:0, left panel) or as sum compositions (i.e. Cer 34:1;O2, left panel). In the latter case, isobaric ceramide species other than the 4 ceramides targeted in this study may therefore have contributed to the reported concentrations. Details of the individual studies are presented in Table S3. No outlier removal has been applied for each of the studies. 

In the dataset "Thompson 2019 (sp)" (Biocrates-Ringtrial), Cer 34:1 (Cer 18:1;O2/16:0) was not available for all participating labs.  

Data Sources:
- 1. Quehenberger, O. et al. Lipidomics reveals a remarkable diversity of lipids in human plasma 1 [S]. Journal of Lipid Research 51, 3299–3305 (2010). Data retrieved from Supplementary Materials.
- 2. Bowden, J. A. et al. Harmonizing lipidomics: NIST interlaboratory comparison exercise for lipidomics using SRM 1950–Metabolites in Frozen Human Plasma[S]. Journal of Lipid Research 58, 2275–2288 (2017). Data retrieved from the plots in "Lipid Concentrations in Standard Reference Material (SRM) 1950: Results from an Interlaboratory" https://doi.org/10.6028/NIST.IR.8185
- 3. Thompson, J. W. et al. International Ring Trial of a High Resolution Targeted Metabolomics and Lipidomics Platform for Serum and Plasma Analysis. Anal. Chem. 91, 14407–14416 (2019). Supplementary Data ac9b02908_si_002.xlsx, Sheets "Table S-1" and "Table S-3"    
- 4. Ghorasaini, M. et al. Cross-Laboratory Standardization of Preclinical Lipidomics Using Differential Mobility Spectrometry and Multiple Reaction Monitoring. Anal. Chem. 93, 16369–16378 (2021). Summary obtained from Supplementary Materials ac1c02826_si_002.xlsx, Sheets "Table S8" and "Table S9", individual data points obtained from the authors directly. 

```{r Fig4-plot, fig.height=8, fig.width=12, out.width="100%"}

# DATA PREP ----- ----------------------------------------------------------

d_quehenberger_orig <- read_csv(here("manuscript/data/Quehenberger_Ceramides_Conc.csv"))
d_bowden_orig <- read_csv(here("manuscript/data/Bowden_InterlabStudy_Ceramides_Conc.csv"))
d_biocrates <- read_csv(here("manuscript/data/Biocrates_Ringtrial_Ceramides.csv"))
d_sum_giera <- read_csv(here("manuscript/data/Giera_MEDM_COD_V1.csv"))
d_giera <- read_csv(here("manuscript/data/Giera_Ringtrial_Ceramides.csv"))

d_ils_labs <- d_srm_mean |> mutate(Study = "ILS Ceramides (mp)", .before = 1) 


# Cer 34:1 (Cer 18:1;O2/16:0) was not available for all participating labs, 
#  this results in warning when plotting

d_biocrates_mean <- d_biocrates |>
  mutate(id = row_number(), .before =1) |> 
  pivot_longer(-id:-LabId, names_to = "Compound", values_to = "Conc") |> 
  group_by(LabId, Compound) |>
  summarise(
    Conc_mean = mean(Conc, na.rm = TRUE),
    CV_intra = sd(Conc, na.rm = TRUE)/mean(Conc, na.rm = TRUE)*100) |> 
  ungroup() |> 
  mutate(LabId = as.character(LabId),
         Study = "Thompson 2019 (sp)", .before = 1) |> 
  dplyr::select(Study, Compound, LabID=LabId, Conc_mean, CV_intra)

d_giera_mean <- d_giera |>
  mutate(id = row_number(), .before =1) |> 
  pivot_longer(-id:-LabId, names_to = "Compound", values_to = "Conc") |> 
  group_by(LabId, Compound) |>
  summarise(
    Conc_mean = mean(Conc, na.rm = TRUE),
    CV_intra = sd(Conc, na.rm = TRUE)/mean(Conc, na.rm = TRUE)*100) |> 
  ungroup() |> 
  mutate(LabId = as.character(LabId),
         Study = "Ghorasaini 2021 (sp)", .before = 1) |> 
  dplyr::select(Study, Compound, LabID=LabId, Conc_mean, CV_intra)

d_biocrates_mean[d_biocrates_mean == "NaN"] <- NA

d_bowden <- d_bowden_orig |> 
  select(LabID = LabId, Compound = Species, Conc_mean = Conc) |> 
  mutate(LabID = as.character(LabID)) |> 
  mutate(Study = "Bowden 2017 (mp)")

d_quehenberger <- d_quehenberger_orig |> 
  select(LabID = LabId, Compound = Species, Conc_mean = Conc) |> 
  mutate(LabID = as.character(LabID)) |> 
  mutate(Study = "Quehenberger 2010")

d_lipidyzer <- d_sum_giera |> 
  select(Study, Compound = Species, everything()) |> 
  mutate(MADM = MAD/MEDM *100) |> 
  mutate(Study = "Ghorasaini 2021 (sp)") |>
  mutate(Compound = str_replace(Compound, fixed("d18:1"), "18:1;O2")) 

# PLOT FUNCTION ----- ----------------------------------------------------------

plot_studycomp <- function(data_ils_study, filename_prefix){ 
  d_plot <- data_ils_study |> 
    filter(SampleType == "SRM") |> 
    select(
      Study,
      LabID = LabId,
      Compound = ceramideName,
      Conc_mean = C_Adj_mean,
      CV_intra = C_Adj_intralabCV
    ) |>  
    bind_rows(d_biocrates_mean) |> 
    bind_rows(d_bowden) |> 
    bind_rows(d_quehenberger) |> 
    bind_rows(d_giera_mean) |> 
    mutate(Study = factor(
      Study,
      levels = c(
        "Quehenberger 2010",
        "Bowden 2017 (mp)",
        "Thompson 2019 (sp)" ,
        "Ghorasaini 2021 (sp)",
        "ILS Ceramides (mp)"
      )
    )) |> 
    arrange(Study) |> 
    mutate(Compound = str_replace(Compound, fixed("d18:1"), "18:1;O2")) |> 
    mutate(Compound = case_when(
      Compound  == "Cer 18:1;O2/16:0" ~ "Cer 34:1;O2 | Cer 18:1;O2/16:0",
      Compound  == "Cer 18:1;O2/18:0" ~ "Cer 36:1;O2 | Cer 18:1;O2/18:0",
      Compound  == "Cer 18:1;O2/24:0" ~ "Cer 42:1;O2 | Cer 18:1;O2/24:0",
      Compound  == "Cer 18:1;O2/24:1" ~ "Cer 42:2;O2 | Cer 18:1;O2/24:1",
          .default = as.character(Compound)
    ))
  
  
  d_stats <- d_plot |> 
    group_by(Compound, Study) |> 
    summarise(
      n_labs = n(),
      MEAN = mean(Conc_mean, na.rm = TRUE),
      SD = sd(Conc_mean, na.rm = TRUE),
      CV = SD/MEAN *100,
      SEM = SD/sqrt(n_labs),
      CV_SEM = SEM/MEAN *100,
      MAD = mad(Conc_mean, constant = 1.4826, na.rm = TRUE),
      MEDM = median(Conc_mean, na.rm = TRUE),
      MADM = MAD/MEDM * 100, 
      Uncertainty = std_uncert(Conc_mean), 
      COD = Uncertainty/MEDM *100, 
      Conc_max = max(Conc_mean, na.rm = TRUE))  |> 
    ungroup() 
  d_stats


readr::write_excel_csv(d_plot, file = here(paste0("manuscript/output/", filename_prefix, "_sourcedata_points.csv")))
readr::write_excel_csv(d_stats, file = here(paste0("manuscript/output/", filename_prefix, "_sourcedata_statistics.csv")))

# Plot annotations
  d_sum <- d_stats |> 
    mutate(Study = factor(Study, levels = c("Quehenberger 2010", "Bowden 2017 (mp)", 
                                            "Thompson 2019 (sp)", "Ghorasaini 2021 (sp)", 
                                            "ILS Ceramides (mp)")))|> 
  arrange(Study) |> 
  # Conc_max used for label positioning only
  mutate(Conc_max = if_else(is.na(Conc_max), MEDM + MAD, Conc_max)) |> 
  group_by(Compound) |>
  mutate(Conc_max = Conc_max + max(Conc_max)*0.05) |> 
  mutate(Compound = case_when(
    Compound  == "Cer 18:1;O2/16:0" ~ "Cer 34:1;O2 | Cer 18:1;O2/16:0",
    Compound  == "Cer 18:1;O2/18:0" ~ "Cer 36:1;O2 | Cer 18:1;O2/18:0",
    Compound  == "Cer 18:1;O2/24:0" ~ "Cer 42:1;O2 | Cer 18:1;O2/24:0",
    Compound  == "Cer 18:1;O2/24:1" ~ "Cer 42:2;O2 | Cer 18:1;O2/24:1",
        .default = as.character(Compound)
  ))

p_Fig4 <- ggplot(d_plot, aes(x = Study, y = Conc_mean)) +
  
  ggbeeswarm::geom_beeswarm(
    shape = 21, size = 2, stroke  = 0.4, dodge.width = .9, cex = 1.3, color = "grey10", alpha = 0.3) +
  geom_crossbar(
    data = d_sum,
    #aes(y = MEDM, ymin = MEDM - Uncertainty, ymax = MEDM + Uncertainty),
    aes(y = MEDM, ymin = MEDM - MAD, ymax = MEDM + MAD),
        inherit.aes = TRUE, 
    fatten = .1, size = 0.2, fill = "grey95", color = "red", width = .6, alpha = 0.1) +
  geom_crossbar(
    data = d_sum,
    aes(y = MEDM, ymin = MEDM, ymax = MEDM),
    inherit.aes = TRUE, fatten = 0, linewidth = 0.8, fill = "grey95", color = "red", width = 0.7) +
  scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(.03, .1))) +
  geom_text(
    data = d_sum,
    aes(label = n_labs, y = Conc_max),
    size = 1.7, nudge_x = 0.0,inherit.aes = TRUE, color = "#d40202", fontface = "italic") +
  facet_wrap(vars(Compound), scales = "free", nrow = 1) +
  scale_x_discrete(drop = FALSE, expand = expansion(mult = c(.03, .25))) +
  theme_classic(base_size = 7) +
  labs(x = "", y = "\U003BCmol/L") +
  theme(
    axis.text.x = element_text(size = 7, angle = 46, vjust = 1, hjust = 1)
    )  + theme(
    axis.text.x = element_text(size = 6, face = "plain",  angle = 46, vjust = 1, hjust = 1),
    axis.text.y = element_text(size = 6, face = "plain", angle = 0),
    axis.title.x = element_text(size = 7, face = "bold", vjust = 1, hjust = 1, margin = margin(t = 8, r = 0, b = 0, l = 0)),
    axis.title.y = element_text(size = 6, face = "bold", angle = 90, margin = margin(t = 0, r = 7, b = 0, l = 8)),
    #panel.grid.major.x = element_line(colour = "grey70", linewidth = 0.2, linetype = "dotted"),
    strip.background = element_rect(fill="grey99")) +
    theme(legend.position.inside = c(.63,.93), 
          legend.key.size = unit(0.2, "cm"),
        legend.spacing.y = unit(.001, 'cm'))
p_Fig4
}

p_Fig4 <- plot_studycomp(d_ils_labs, filename_prefix = "Fig4_")

ggsave(plot = p_Fig4, filename = here("manuscript/output/Fig4_Comparison_Studies.png"), device = "png",
dpi = 600, width =160, height =75, units = "mm")

p_Fig4
```

# 11. Figure 5: Normalization with different ISTDs

Authentic vs class-specific internal standard normalization and its effects on bias and variability of concentrations from multi-point calibration.  The horizontal bars correspond to the mean and ±1 SD of all points per group. Data originating from the same laboratory are connected by dashed lines. Dataset 15 was excluded for Cer 18:1;O2/16:0 as it had 15x higher concentrations than the second highest point for C24:0 d7. SOP (red) and OTHER (blue) refer to the Standard vs Other methods, respectively. Outlier in the authentic internal standard groups have been removed (see Figure 1 and text).

```{r Fig5-plot, fig.height=8, fig.width=6, out.width="100%"}

d_istd <- read_csv(here("data/definitions/labeledISConcentrations.csv")) |>   
  mutate(ceramideName = str_replace(ceramideName, fixed("d18:1"), "18:1;O2"),
         conc_istd = Concentration) 

d_plot_norm_istd_mp <- d_srm_mean_filt_mp |> 
  filter(SampleType == "SRM") |>
  select(SampleType, LabId, ceramideName, Protocol, LC,  C_Adj_mean, C_Adj_C16_mean, C_Adj_C24_mean) |> 
  pivot_longer(-SampleType:-LC, names_to = c("ISTD"), values_to = "Concentration") |> 
  filter(!(ceramideName == "Cer 18:1;O2/16:0" & ISTD == "C_Adj_C16_mean")) |> 
  filter(!(ceramideName == "Cer 18:1;O2/24:0" & ISTD == "C_Adj_C24_mean")) |> 
  filter(LabId != "15") |> 
  filter(ceramideName == "Cer 18:1;O2/16:0" | ceramideName == "Cer 18:1;O2/24:0" ) 


plot_diffistd <- function(data, y_title, n_label_offset = 20, legend_x_offset = 0.11, n_label_size = 1.3, filename_prefix = "NormDiffISTD") {
  
  data$ISTD <- forcats::fct_recode(data$ISTD, "AuthISTD" = "C_Adj_mean", "C16_ISTD" = "C_Adj_C16_mean" , "C18_ISTD" = "C_Adj_C18_mean" , "C24_ISTD" = "C_Adj_C24_mean", "C241_ISTD" = "C_Adj_C241_mean",)
  data$ISTD <- forcats::fct_relevel(data$ISTD, c("AuthISTD", "C16_ISTD", "C18_ISTD", "C24_ISTD", "C241_ISTD"))
  data$Protocol <- forcats::fct_relevel(forcats::as_factor(data$Protocol), c("SOP", "OTHER"))
  data$LC <- forcats::fct_relevel(data$LC, c("RP", "FIA", "SFC"))
  data <- data |> arrange( ISTD)
  
  
  d_plot_stats <- data |> 
  ungroup() |> 
  #filter(str_detect(ceramideName, "24\\:0"),  ISTD != "C18_ISTD") |> 
  group_by(ceramideName, ISTD) |> 
  dplyr::summarise(
    N = n(),
    Mean = mean(Concentration),
    SD = sd(Concentration),
    CV = sd(Concentration)/mean(Concentration) *100) |> ungroup()

  readr::write_excel_csv(data, file = here(paste0("manuscript/output/", filename_prefix, "_sourcedata_points.csv")))
  readr::write_excel_csv(d_plot_stats, file = here(paste0("manuscript/output/", filename_prefix,"_sourcedata_statistics.csv")))

  
  
  d_sum <- data |> 
    ungroup() |> 
    mutate(y_max = max(Concentration), .by = ceramideName) |> 
    summarise(
      n_labs = paste0("n=",n()), 
      conc_min = min(Concentration) - mean(y_max)/n_label_offset,
      .by = c(ISTD, ceramideName)
    )
  
  pos <- ggbeeswarm::position_beeswarm(dodge.width = 0.07, method = "center")
  plt <- ggplot(data |> arrange(ISTD), 
                  aes(x = ISTD, y = Concentration, color = Protocol, fill = Protocol, group = LabId, shape = LC)) +
    geom_line(aes(group = LabId), position = pos, alpha = 0.2, linewidth = 0.2, linetype = "longdash") + 
    geom_point(data = data |>  filter(LC == "RP"), position = pos, size = 1.5, stroke = 0.2,alpha = 0.9)  + 
    geom_point(data = data |> filter(LC != "RP"), position = pos, size = 1.5, stroke = 0.2,alpha = 0.9)  + 
  
      #ggbeeswarm::geom_beeswarm(cex = 2.5,size = 1.2, stroke = .2, method = "swarm", priority = "random", alpha = .7, shape = 21) +  
          stat_summary(aes(x = ISTD, y = Concentration), geom = "errorbar",inherit.aes = FALSE,
                 width = .3,
                 color = "darkred",
                 linewidth = 0.25,
                 alpha = 0.6, 
                 fun.min = \(x) mean(x) - sd(x),
                 fun.max = \(x) mean(x) + sd(x)) +
  
        stat_summary(aes(x = ISTD, y = Concentration), 
                 fun = "mean",
                  geom = "crossbar",inherit.aes = FALSE,
                 width = .4,
                 color = "darkred",
                 linewidth = 0.2, alpha = 0.7)+
    
  
    facet_wrap(vars(ceramideName), scales = "free", nrow = 1) +
    scale_fill_manual(values = c("SOP" = "#ffc2c2", "OTHER" = "#d1dcff"), labels=c("SOP", "OTHER")) +
    scale_color_manual(values = c("SOP" = "#e30202", "OTHER" = "darkblue"), labels=c("SOP", "OTHER")) + 
    scale_shape_manual(values = c("RP" = 21, "FIA" = 18, "SFC"=17 ), 
                       labels=c("RP", "FIA","SFC"), name = NULL) + 
    guides(shape = guide_legend(order = 2,
                                override.aes = list(alpha = c(1,0.5,0.5), fill = c("grey80", "darkblue", "darkblue"), shape=c(21,23,24))),
           color = guide_legend(order = 1, override.aes = list(color = c("#e30202","darkblue"))),
           fill = guide_legend(order = 1, override.aes = list(fill = c("#ffc2c2", "#d1dcff") ))) +
    scale_y_continuous(limits = c(0, NA)) +
    
    facetted_pos_scales(
      x = list(
        ceramideName == "Cer 18:1;O2/16:0" ~ 
          scale_x_discrete(labels = c("AuthISTD" = "C16:0 d7\n(Authentic)", 
                                      "C18_ISTD" = "C18:0 d7", 
                                      "C24_ISTD" = "C24:0 d7",
                                      "C241_ISTD" = "C24:1 d7")),
        ceramideName == "Cer 18:1;O2/18:0" ~ 
          scale_x_discrete(labels = c("AuthISTD" = "C18:0 d7\n(Authentic)", 
                                      "C16_ISTD" = "C16:0 d7", 
                                      "C24_ISTD" = "C24:0 d7",
                                      "C241_ISTD" = "C24:1 d7")),
        ceramideName == "Cer 18:1;O2/24:0" ~ 
          scale_x_discrete(labels = c("AuthISTD" = "C24:0 d7\n(Authentic)", 
                                      "C16_ISTD" = "C16:0 d7",
                                      "C18_ISTD" = "C18:0 d7",
                                      "C241_ISTD" = "C24:1 d7")),
        ceramideName == "Cer 18:1;O2/24:1" ~ 
          scale_x_discrete(labels = c( "AuthISTD" = "C24:1 d7\n(Authentic)", 
                                       "C24_ISTD" = "C24:0 d7", 
                                       "C16_ISTD" = "C16:0 d7",
                                       "C18_ISTD" = "C18:0 d7"))
      )) + 
    
    geom_text(
      data = d_sum,
      aes(label = n_labs, x = ISTD , y = conc_min),
      size = n_label_size, nudge_x = 0.0,inherit.aes = FALSE, color = "grey60", fontface = "italic"
    ) +
    
    #scale_linetype_manual(values = c("SOP" = "solid", "OTHER" = "dotted"))+
    labs(color=NULL, fill = NULL)+
    theme_classic(base_size = 7) +  
    labs(y=y_title, x="Internal standard")+
    #scale_x_discrete(drop = FALSE, expand = expansion(mult = c(.03, .05))) +
    theme(
      axis.text.x = element_text(size = 6, face = "plain", angle = 0),
      # axis.text.y = element_text(size = 6, face = "plain", angle = 0),
      axis.title.x = element_text(size = 6, face = "bold", angle = 0, margin = margin(t = 8, r = 0, b = 0, l = 0)),
      axis.title.y = element_text(size = 6, face = "bold", angle = 90, margin = margin(t = 0, r = 7, b = 0, l = 8)),
      plot.title = element_text(size=6, face = "bold"),
      #panel.grid.major.x = element_line(colour = "grey70", linewidth = 0.2, linetype = "dotted"),
      strip.background = element_rect(fill="grey99")) +
      theme(legend.position.inside = c(legend_x_offset, 0.83), 
            legend.key.size = unit(0.1, "cm"),
          legend.spacing.y = unit(.001, 'cm'))
  
    plt
  }



p_Fig5  <- plot_diffistd(d_plot_norm_istd_mp, "\U003BCmol/L (multi-point calibration)", n_label_offset = 20,  filename_prefix = "Fig5")

ggsave(plot = p_Fig5, filename = here("manuscript/output/Fig5_DifferentISTDs.png"), device = "png",
dpi = 600, width =80, height =65, units = "mm")

p_Fig5





```

# 12. Figure 6: SRM-normalization

Concentration of the 4 reported ceramides in NIST DB plasma before and after re-calibration using the NIST SRM 1950 concentration. Each circle corresponds to one measurement from one NIST DB sample shipped to each of the participating laboratories before (None) and after (SRM 1950) re-calibration with the SRM1950 concentration of the corresponding laboratory (see text). The horizontal bars correspond to the mean and ±1 SD of all points per group. This plot contains all datasets before and after re-calibration, no outlier removal has been performed.

```{r Fig6-plot, fig.height=8, fig.width=12, out.width="100%"}

d_plot <- flag_outlier(d_srm_mean, limit_iqr = limit_iqr)


p_Fig6 <- plot_comparison_norm(d_srm_mean = d_plot,variable = "C_Adj",sample_type = "DB",normalisation_sample = "SRM",
                               save_plot = TRUE, filename_prefix = "Fig6_", pos = pos, show_n = TRUE) + 
  ggplot2::labs(y = "NIST DB, \U003BCmol/L (multi-point calibration)")

ggsave(plot = p_Fig6, filename = here("manuscript/output/Fig6_normNIST_DB.png"), device = "png", 
  dpi = 600, width =160, height =65, units = "mm")

p_Fig6
```

# 13. Suppl Figure S1: External Calibration Curves

Log-log plot of mean calibration lines over all participating labs and protocols. Each concentration step of the calibration line samples is depicted as a blue dot, steps are connected by a blue solid line. The blue ribbons highlight the respective mean ±1SD. Median values are indicated by black dots and connected by a gray dashed line. The green line corresponds to the theoretical equimolar response of spiked-in non-labelled and labelled standards. The red line and ribbon correspond to the actual mean area ratios in the measured NIST SRM 1950 RM samples and the mean ±1SD, respectively, illustrating the suitability of the calibration lines to capture the expected concentrations of the four ceramides.

```{r FigS01-plot, fig.height=5, fig.width=5, out.width="100%"}
if(params$run_in_targets) {
  tar_read(meanSdCalibrationLinesPlotsAvgRatioObj)[[1]]
} else {
  knitr::include_graphics(here("output/CalibrationLinesAvgMedRangeLog10-with-NISTSRM-AvgRatio.png"))
}
fs::file_copy(path = here("output/CalibrationLinesAvgMedRangeLog10-with-NISTSRM-AvgRatio.png"), new_path = here("manuscript/output/FigS01_CalibrationLinesAvgMedRangeLog10-with-NISTSRM-AvgRatio.png"), overwrite = TRUE)
fs::file_copy(path = here("output/CalibrationLinesAvgMedRangeLog10-with-NISTSRM-AvgRatio.csv"), new_path = here("manuscript/output/FigS01_CalibrationLinesAvgMedRangeLog10-with-NISTSRM-AvgRatio_sourcedata.csv"), overwrite = TRUE)
```

# 14. Suppl Figure S2: Single Point Quantification of NIST SRM 1950

Concentration of the 4 reported ceramides in NIST SRM 1950 based on direct quantification using the internal standard (single point). Each circle corresponds to one measurement from one NIST SRM sample shipped to each of the participating laboratories. Horizontal bars are mean values of the data reported form each participant, while error bars (in some instances) indicate ±1SD of replicate measurements of the same sample. The outer green dotted lines indicate Tukey’s Q1–1.5*interquartile range (IQR) and Q3+1.5*IQR used for as cut-off values for outlier removal. The mean ± 2SD (solid grey and dashed grey lines) is based on the data after outlier removal. SOP (red) and OTHER (blue) refer to the Standard vs OTHER methods, respectively.

```{r FigS02-plot, fig.height=8, fig.width=12, out.width="100%"}
singlePointSRM1950Plot <- plot_labscatter(
  d_sample_mean = d_sample_mean,
  d_srm_mean = d_srm_mean,
  variable = "C_SinglePoint",
  sample_type = "SRM",
  labid_col = "LabNum",
  normalisation_sample = NULL,
  excluded_labs = "",
  save_plot = TRUE,
  C16_max = NA,
  C18_max = NA,
  C24_max = NA,
  C241_max = NA,
  filename_prefix = "FigS02"
)

singlePointSRM1950Plot
```

# 15. Suppl Figure S3: Single vs multi-point calibration with and without outliers

Molar concentrations derived from single point internal standard (ISTD) vs. calibration curve-based quantifications of the full (A) and outlier-filtered (B) dataset. The diagonal line indicates equal results between single point (horizontal axis) and calibration curve-based quantification (vertical axis). Outlier measurements were removed for each ceramide species reference plasma (see Figure 1 and text). NIST SRM 1950 (SRM, blue); hypertriglyceridemic (hTAG, red), diabetic (DB, purple), and African American (YAA, green), which are part of NIST RM 8231.

```{r FigS03-plot, fig.height=5, fig.width=12, out.width="100%"}
d_srm_mean_plot <- flag_outlier(d_srm_mean, limit_iqr = limit_iqr)  #|> filter(!Outlier_sp, !Outlier_mp)
d_srm_mean_plot$SampleType <- forcats::fct_relevel(d_srm_mean_plot$SampleType, c("DB","hTAG","YAA","SRM"))
pS03A <- plot_single_vs_multipoint(d_srm_mean_plot, c(0.8, 0.22, 7.2, 2.6))
readr::write_excel_csv(d_srm_mean_plot, file = here(paste0("manuscript/output/FigS03A_sourcedata.csv")))

d_srm_mean_filt <- flag_outlier(d_srm_mean, limit_iqr = limit_iqr)  |> filter(!Outlier_sp, !Outlier_mp)
d_srm_mean_filt$SampleType <- forcats::fct_relevel(d_srm_mean_filt$SampleType, c("DB","hTAG","YAA","SRM"))
pS03B <- plot_single_vs_multipoint(d_srm_mean_filt, c(0.8, 0.22, 7.2, 2.6))
readr::write_excel_csv(d_srm_mean_filt, file = here(paste0("manuscript/output/FigS03B_sourcedata.csv")))

pS03 <- pS03A / pS03B + patchwork::plot_annotation(tag_levels = c("A", "B"))

ggsave(plot = pS03, filename = here("manuscript/output/FigS03_Comparison_SingleVsMultiCalib-All-FilteredDatasets.png"), device = "png",
dpi = 600, width =160, height =120, units = "mm")

pS03
```

# 16. Suppl Figure S4: SRM comparisons

Concentrations of the 4 ceramides in different NIST reference plasma samples of the full (A) and outlier-filtered (B) dataset. Each circle corresponds to the values reported by one laboratory. P values are based on paired t-tests of complete datasets. The horizontal bars correspond to the mean and ±1 SD of all points per group. SOP (red) and OTHER (blue) refer to the Standard vs Other methods, respectively. Outlier measurements in (B) were removed for ceramide species in each reference plasma (see Figure 1 and text). 

```{r FigS04-plot, fig.height=8, fig.width=12, out.width="100%"}
pos_points <- ggbeeswarm::position_beeswarm(cex = 1, dodge.width = 0.2)

d_srm_mean_plot <- flag_outlier(d_srm_mean, limit_iqr = limit_iqr) # |> filter(!Outlier_mp)
d_srm_mean_plot$SampleType <- forcats::fct_relevel(d_srm_mean_plot$SampleType, c("SRM","hTAG","DB","YAA")) 
pS04A <- plot_all_refmaterials(d_srm_mean_plot, xy_lim = c(0.7, 0.25, 9, 3))
readr::write_excel_csv(d_srm_mean_plot, file = here(paste0("manuscript/output/Fig4A_sourcedata.csv")))

d_srm_mean_filt <- flag_outlier(d_srm_mean, limit_iqr = limit_iqr) |> filter(!Outlier_mp)
d_srm_mean_filt$SampleType <- forcats::fct_relevel(d_srm_mean_filt$SampleType, c("SRM","hTAG","DB","YAA")) 
pS04B <- plot_all_refmaterials(d_srm_mean_filt, xy_lim = c(0.7, 0.25, 9, 3))
readr::write_excel_csv(d_srm_mean_filt, file = here(paste0("manuscript/output/Fig4B_sourcedata.csv")))

pS04 <- pS04A / pS04B + patchwork::plot_annotation(tag_levels = c("A", "B"))

ggsave(plot = pS04, filename = here("manuscript/output/FigS04_SRMs_Dotplots-All-FilteredDataset.png"), device = "png",
dpi = 600, width =160, height =130, units = "mm")

pS04

get_Fig4_stats <- function(data){
  data |> 
    summarise(
      .by = c(ceramideName, SampleType),
      n_labs = n(),
      MEAN = mean(C_Adj_mean, na.rm = TRUE),
      SD = sd(C_Adj_mean, na.rm = TRUE)
    )
}
readr::write_excel_csv(get_Fig4_stats(d_srm_mean_plot), file = here(paste0("manuscript/output/Fig4A_sourcedata_statistics.csv")))
readr::write_excel_csv(get_Fig4_stats(d_srm_mean_filt), file = here(paste0("manuscript/output/Fig4B_sourcedata_statistics.csv")))
```

# 17. Suppl Figure S5: Interlaboratory Study Comparisons

Comparison of inter-laboratory and/or cross-platform trials reporting ceramide concentrations in NIST SRM 1950 with the full (A) and outlier-filtered (B) ILS ceramide dataset. Each open circle corresponds to the reported value from one laboratory in each of the respective studies referenced by first author and year of publication. (sp) refers to a single, standardized protocol and platform employed by all laboratories while (mp) denotes studies in which multiple protocols and platforms were used. The red boxes and numbers indicate median ± MAD (mean absolute deviation) and the number of participating laboratories respectively. Depending on the precise nature of the study and/or reporting laboratory, concentrations were either reported with sphingoid-base and fatty details (e.g. Cer 18:1;O2/16:0, left panel) or as sum compositions (i.e. Cer 34:1;O2, left panel). In the latter case, isobaric ceramide species other than the 4 ceramides targeted in this study may therefore have contributed to the reported concentrations. Details of the individual studies are presented in Table S3. No outlier removal has been applied for each of the studies. 

```{r FigS05-dataprep-plot, fig.height=8, fig.width=12, out.width="100%"}
d_ils_labs_filt <- d_srm_mean_filt_mp |> mutate(Study = "ILS Ceramides (mp)", .before = 1) 

pS05B <- plot_studycomp(d_ils_labs_filt, filename_prefix = "FigS05")

pS05 <- p_Fig4 / pS05B + patchwork::plot_annotation(tag_levels = c("A", "B"))

ggsave(plot = pS05, filename = here("manuscript/output/FigS05_Comparison_Studies.png"), device = "png",
dpi = 600, width =160, height = 150, units = "mm")

pS05
```

# 18. Suppl Figure S6: Normalization with different ISTDs (full and outlier-filtered datasets)

Authentic vs class-specific internal standard normalization and its effects on bias and variability. Concentrations are based on multi-point calibration. The horizontal bars correspond to the mean and ±1×SD of all points per group. Data originating from the same laboratory are connected by dashed lines. SOP (red) and OTHER (blue) refer to the Standard vs other methods, respectively. Outliers in the authentic internal standard groups have been removed (see Figure 1 and text). For panel B, outliers in the authentic internal standard groups have been removed in all groups for each ceramide species (see Figure 1 and text). Dataset 11 was excluded for Cer16:0 in panels A and B as it had 15x higher concentrations than the second highest data point for C24:0 D7 normalization. The number of data points is indicated below each group. 

```{r FigS06-plot, fig.height=8, fig.width=6, out.width="100%"}

##### Multi-Point Calibrated Dataset  -------------------------------------

d_istd <- read_csv(here("data/definitions/labeledISConcentrations.csv")) |>   
  mutate(ceramideName = str_replace(ceramideName, fixed("d18:1"), "18:1;O2"),
         conc_istd = Concentration) 

d_plot_allistd_mp <- d_srm_mean |> 
  filter(SampleType == "SRM") |>
  select(SampleType, LabId, ceramideName, Protocol, LC, C_Adj_mean, C_Adj_C16_mean, C_Adj_C18_mean, C_Adj_C24_mean, C_Adj_C241_mean) |> 
  pivot_longer(-SampleType:-LC, names_to = c("ISTD"), values_to = "Concentration") |> 
  filter(!(ceramideName == "Cer 18:1;O2/16:0" & ISTD == "C_Adj_C16_mean")) |> 
  filter(!(ceramideName == "Cer 18:1;O2/18:0" & ISTD == "C_Adj_C18_mean")) |> 
  filter(!(ceramideName == "Cer 18:1;O2/24:0" & ISTD == "C_Adj_C24_mean")) |> 
  filter(!(ceramideName == "Cer 18:1;O2/24:1" & ISTD == "C_Adj_C241_mean")) |> 
  filter(LabId != "15") |> 
  filter(ceramideName == "Cer 18:1;O2/16:0" | ceramideName == "Cer 18:1;O2/18:0" | ceramideName == "Cer 18:1;O2/24:0" | ceramideName == "Cer 18:1;O2/24:1" ) 

d_plot_allistd_mp_filt <- d_srm_mean_filt_mp |> 
  filter(SampleType == "SRM") |>
  select(SampleType, LabId, ceramideName, Protocol, LC,  C_Adj_mean, C_Adj_C16_mean, C_Adj_C18_mean, C_Adj_C24_mean, C_Adj_C241_mean) |> 
  pivot_longer(-SampleType:-LC, names_to = c("ISTD"), values_to = "Concentration") |> 
  filter(!(ceramideName == "Cer 18:1;O2/16:0" & ISTD == "C_Adj_C16_mean")) |> 
  filter(!(ceramideName == "Cer 18:1;O2/18:0" & ISTD == "C_Adj_C18_mean")) |> 
  filter(!(ceramideName == "Cer 18:1;O2/24:0" & ISTD == "C_Adj_C24_mean")) |> 
  filter(!(ceramideName == "Cer 18:1;O2/24:1" & ISTD == "C_Adj_C241_mean")) |> 
  filter(LabId != "15") |> 
  filter(ceramideName == "Cer 18:1;O2/16:0" | ceramideName == "Cer 18:1;O2/18:0" | ceramideName == "Cer 18:1;O2/24:0" | ceramideName == "Cer 18:1;O2/24:1" ) 



p_Fig6C_allistd_mp  <- plot_diffistd(
  data = d_plot_allistd_mp, 
  y_title = "\U003BCmol/L (multi-point calibration)", 
  n_label_offset = 25, 
  legend_x_offset = 0.963, 
  n_label_size = 2, 
  filename_prefix = "Fig6C") + 
  ggtitle("Multi-point calibration (all data)") + xlab("")

p_Fig6A_allistd_mp_filt  <- plot_diffistd(
  data = d_plot_allistd_mp_filt, 
  y_title = "\U003BCmol/L (multi-point calibration)", 
  n_label_offset = 20, 
  legend_x_offset = 0.963, 
  n_label_size = 2,
  filename_prefix = "Fig6A") + ggtitle("Multi-point calibration (outliers removed)")


# Export data used to generate plot

d_plot_allistd_mp_stats <- d_plot_allistd_mp |> mutate(Outlier_filt  = FALSE) |> 
  bind_rows(d_plot_allistd_mp_filt |> mutate(Outlier_filt  = TRUE)) |> 
  ungroup() |> 
  #filter(str_detect(ceramideName, "24\\:0"),  ISTD != "C18_ISTD") |> 
  group_by(ceramideName, ISTD, Outlier_filt) |> 
  dplyr::summarise(
    Outlier_filt = Outlier_filt[1],
    N = n(),
    Mean = mean(Concentration),
    SD = sd(Concentration),
    CV = sd(Concentration)/mean(Concentration) *100) |> 
  arrange(Outlier_filt,ceramideName)

write_csv(x = d_plot_allistd_mp_stats, here("manuscript/output/FigS06_data-summary-stats-mp.csv"))


##### Single-Point Calibrated Dataset  -------------------------------------

# Calculate data

d_raw_OTHER <- read_csv(here("output/all-labs-preferred-unfiltered.csv"))
d_raw_sop <- read_csv(here("output/all-labs-standard-unfiltered.csv"))
d_istd <- read_csv(here("data/definitions/labeledISConcentrations.csv")) |>   
  mutate(ceramideName = str_replace(ceramideName, fixed("d18:1"), "18:1;O2"),
         conc_istd = Concentration) 

d_raw <- bind_rows(d_raw_OTHER, d_raw_sop) |> 
  filter(SampleType == "NIST SRM") |> 
  left_join(d_protocols |> select(LabId, LC), by = "LabId") |> 
  select(SampleType, isotope, ceramideName, ceramideId, Protocol, LC, Sample, replicate, LabId, MassAnalyzerType,  Intensity = area) |> 
  mutate(ceramideName = str_replace(ceramideName, fixed("d18:1"), "18:1;O2")) |> 
  group_by(SampleType, ceramideName, Protocol, LC,  Sample, replicate, LabId, MassAnalyzerType) |> 
  separate(LabId, into = c("LabId_group", "MethodNo"), convert = FALSE, remove = FALSE, sep = "[abc]", fill = "right") |> 
  mutate(
    MethodNo = str_extract(LabId, "[abc]"),
    MethodNo = if_else(is.na(MethodNo), "a", MethodNo),
    Protocol = if_else(Protocol == "Standard", "SOP", "OTHER"), 
    SampleType = str_replace(SampleType, "NIST ", ""),
    MassAnalyzerResolution = if_else(MassAnalyzerType == "QQQ", "LowRes", "HighRes")) |> 
  group_by(LabId_group) |> 
  mutate(LabNum = dplyr::cur_group_id()) |> 
  ungroup() |> 
  distinct() 

d_raw$LC <- forcats::fct_relevel(d_raw$LC, c("RP","SFC", "FIA")) 
d_raw$Protocol <- forcats::fct_relevel(d_raw$Protocol, c("SOP","OTHER")) 
d_raw$SampleType <- forcats::fct_relevel(d_raw$SampleType, c("SRM","hTAG","DB","YAA")) 
d_raw$MassAnalyzerResolution <- forcats::fct_relevel(d_raw$MassAnalyzerResolution, c("LowRes","HighRes"))

d_calc <- d_raw |> 
  group_by(SampleType, LabId,LabNum, MethodNo, Sample, Protocol, LC, replicate) |> 
  dplyr::reframe(
    ceramideName = ceramideName[1:4],
    AuthISTD = Intensity[isotope == "l"]/Intensity[isotope == "h"],
    C16_ISTD = Intensity[isotope == "l"]/Intensity[isotope == "h" & ceramideName == "Cer 18:1;O2/16:0"],
    C18_ISTD = Intensity[isotope == "l"]/Intensity[isotope == "h" & ceramideName == "Cer 18:1;O2/18:0"],
    C24_ISTD = Intensity[isotope == "l"]/Intensity[isotope == "h" & ceramideName == "Cer 18:1;O2/24:0"],
    C241_ISTD = Intensity[isotope == "l"]/Intensity[isotope == "h" & ceramideName == "Cer 18:1;O2/24:1"]) |> 
  group_by(SampleType, ceramideName, LabId,LabNum,MethodNo, Protocol, LC,  Sample) |>
  summarise(
    AuthISTD = mean(AuthISTD, na.rm = TRUE),
    C16_ISTD = mean(C16_ISTD, na.rm = TRUE),
    C18_ISTD = mean(C18_ISTD, na.rm = TRUE),
    C24_ISTD = mean(C24_ISTD, na.rm = TRUE),
    C241_ISTD = mean(C241_ISTD, na.rm = TRUE)
  ) |> 
  group_by(SampleType, ceramideName, Protocol, LabId, MethodNo, LC, LabNum) |>
  summarise(
    AuthISTD = mean(AuthISTD, na.rm = TRUE),
    C16_ISTD = mean(C16_ISTD, na.rm = TRUE),
    C18_ISTD = mean(C18_ISTD, na.rm = TRUE),
    C24_ISTD = mean(C24_ISTD, na.rm = TRUE),
    C241_ISTD = mean(C241_ISTD, na.rm = TRUE)
  ) |> 
  left_join(d_istd) |> 
  mutate(
    AuthISTD = AuthISTD * conc_istd,
    C16_ISTD = C16_ISTD * d_istd[d_istd$ceramideId == 1,] |> pull(conc_istd),
    C18_ISTD = C18_ISTD * d_istd[d_istd$ceramideId == 2,] |> pull(conc_istd),
    C24_ISTD = C24_ISTD * d_istd[d_istd$ceramideId == 3,] |> pull(conc_istd),
    C241_ISTD = C241_ISTD * d_istd[d_istd$ceramideId == 4,] |> pull(conc_istd))
 
d_outlier <- flag_outlier(d_srm_mean, limit_iqr = limit_iqr) |> select(SampleType, LabId, ceramideName, Protocol, LC, Outlier_sp, Outlier_mp)

d_calc_plot <- d_calc |> 
  select(LabId, LabNum,ceramideName, Protocol, LC, MethodNo, AuthISTD, C16_ISTD, C18_ISTD,C24_ISTD, C241_ISTD) |> 
  pivot_longer(names_to = "ISTD", values_to = "Concentration", cols = AuthISTD:C241_ISTD) |> 
  filter(!LabId %in% c("15")) |> 
  filter(!(ceramideName == "Cer 18:1;O2/16:0" & ISTD == "C16_ISTD")) |> 
  filter(!(ceramideName == "Cer 18:1;O2/18:0" & ISTD == "C18_ISTD")) |> 
  filter(!(ceramideName == "Cer 18:1;O2/24:0" & ISTD == "C24_ISTD")) |> 
  filter(!(ceramideName == "Cer 18:1;O2/24:1" & ISTD == "C241_ISTD")) |> 
  #filter(!(ISTD == "C24_ISTD")) |> 
  left_join(d_outlier |> select(ceramideName, SampleType, LabId, Outlier_sp, Outlier_mp), by = c("ceramideName", "LabId", "SampleType")) 

# Generate plots

pos <- ggbeeswarm::position_beeswarm(dodge.width = 0.07, method = "center")

d_plot_allistd_sp <- d_calc_plot #|> filter(str_detect(ceramideName, "16|24\\:0"), ISTD != "C18_ISTD") 

p_FigS06D_allistd_sp_alldata  <- plot_diffistd(
  data = d_plot_allistd_sp, 
  y_title = "\U003BCmol/L (single-point calibration)", 
  n_label_offset = 15, 
  legend_x_offset = 0.9633, 
  n_label_size = 2, 
  filename_prefix = "Fig6D") + 
  ggtitle("Single-point calibration (all data)",) + 
  xlab("") +
  scale_y_continuous(expand = expansion(mult = 0.07, add = 0))

p_FigS06B_allistd_sp_filt <- plot_diffistd(
  data = d_plot_allistd_sp |> filter(!Outlier_sp|is.na(Outlier_sp)) |> filter(!LabId %in% c("04", "18b", "31", "30", "38", "10a")) ,
  y_title =  "\U003BCmol/L (single-point calibration)", 
  n_label_offset = 15, 
  legend_x_offset = 0.9633, 
  n_label_size = 2,
  filename_prefix = "Fig6B") + 
  ggtitle("Single-point calibration (outliers removed)") + 
  xlab("") +
  scale_y_continuous(expand = expansion(mult = 0.07, add = 0))

# Export data used to generate plot

d_plot_allistd_spmp_stats <- d_plot_allistd_mp |> mutate(Calibration  = "Multi-Point") |> 
  bind_rows(d_plot_allistd_sp |> mutate(Calibration  = "Single-Point")) |> 
  ungroup() |> 
  #filter(str_detect(ceramideName, "24\\:0"),  ISTD != "C18_ISTD") |> 
  group_by(ceramideName, ISTD, Calibration) |> 
  dplyr::summarise(
    Calibration = Calibration[1],
    N = n(),
    Mean = mean(Concentration),
    SD = sd(Concentration),
    CV = sd(Concentration)/mean(Concentration) *100) |> 
  arrange(Calibration,ceramideName)

write_csv(x = d_plot_allistd_mp_stats, here("manuscript/output/FigS06_data-summary-stats-sp.csv"))


##### Combine Plots and Save Dataset  -------------------------------------

pS6ABCD <- p_Fig6A_allistd_mp_filt /  p_FigS06B_allistd_sp_filt / p_Fig6C_allistd_mp / p_FigS06D_allistd_sp_alldata  + patchwork::plot_annotation(tag_levels = c("A", "B", "C", "D"))


ggsave(plot = pS6ABCD, filename = here("manuscript/output/FigS06_DifferentISTDs-MP-SP_full-filt-dataset.png"), device = "png",
dpi = 600, width =200, height =250, units = "mm")

pS6ABCD

```

# 19. Suppl Figure S7: Normalization to NIST SRM 1950 for hTAG

Re-calibration of hTAG using SRM 1950 after multi-point calibration. All datasets are shown here, but the indicated %CVs are based on a datasets where outliers in the SRM1950 were excluded (see Figure 1 and text).

```{r FigS07-plot, fig.height=8, fig.width=12, out.width="100%"}
inputs <- list(
  list(sample_type="hTAG", plot_file_prefix="FigS07"),
  list(sample_type="DB", plot_file_prefix="FigS08"),
  list(sample_type="YAA", plot_file_prefix="FigS09")
)

labScatterPlots <- inputs |> map(\(x) labScatterPlot(sample_type = x$sample_type, 
                                                     d_sample_mean = d_sample_mean, 
                                                     d_srm_mean = d_srm_mean, 
                                                     variable = "C_Adj", 
                                                     normalisation_sample = "SRM", 
                                                     name_prefix = x$plot_file_prefix))

labScatterPlots[[1]]$p_comb
```


# 20. Suppl Figure S8: Normalization to NIST SRM 1950 for DB

Re-calibration of hTAG using SRM 1950 after single-point calibration. All datasets are shown here, but the indicated %CVs are based on a datasets where outliers in the SRM1950 were excluded (see Figure 1 and text).

```{r FigS08-plot, fig.height=8, fig.width=12, out.width="100%"}

labScatterPlots[[2]]$p_comb
```

# 21. Suppl Figure S9: Normalization to NIST SRM 1950 for YAA

Re-calibration of DB using SRM 1950 after multi-point calibration. All datasets are shown here, but the indicated %CVs are based on a datasets where outliers in the SRM1950 were excluded (see Figure 1 and text).

```{r FigS09-plot, fig.height=8, fig.width=12, out.width="100%"}
labScatterPlots[[3]]$p_comb
```


# 22. Additional Tables (not part of the manuscript)

## 22a - Summary calibration lines raw intensities of labelled vs non-labelled ceramide species

```{r table-res-caliblines}
if (params$run_in_targets) {
  d_caliblines <- tar_read(analyteConcentrationsFromCalibLinesFile)
} else {
  d_caliblines <- readr::read_csv(file = here("output/analyteConcentrationsFromCalibLines.csv"))
}

d_caliblines_areas_mean <- d_caliblines |> 
  group_by(ceramideName, LabId, Sample) |> 
  summarise(area_l = mean(area_l), 
            area_h = mean(area_h))

write_csv(x = d_caliblines_areas_mean, file = here("manuscript/output/Unpublished_summary_calibration-lines_areas-light-heavy.csv"))

d_caliblines_areas_mean
```

## 22b - Comparison between low- and high-resolution instruments in terms of concentration and inter-lab %CV

Concentrations and inter-lab %CV of ceramide species measured by either low-resolution (QQQ) or high-resolution (QTOF/QE) MS instruments. The concentrations given in µmol/L were obtained using  multi-point calibration and filtered for outliers. The P values are from the comparison of individual values from the two instrument resolution categories (Welch’s two-sided t-test). N corresponds to the number of datasets after outlier removal.

```{r other-tables-lowres-vs-highres-ms}

# Table comparison low vs high-resolution MS ----

d_srm_mean_mstype <- d_srm_mean
d_srm_mean_mstype$MassAnalyzerResolution <- factor(d_srm_mean_mstype$MassAnalyzerResolution)

d_srm_mean_mstype <- flag_outlier(d_srm_mean_mstype, limit_iqr = limit_iqr) |> filter(!Outlier_mp)
d_srm_mean_mstype$SampleType <- forcats::fct_relevel(d_srm_mean_mstype$SampleType, c("SRM","hTAG","DB","YAA")) 

d_srm_mean_mstype_stats_part1 <- d_srm_mean_mstype |> 
  group_by(ceramideName, SampleType) |> 
  nest() |> 
    mutate(res = purrr::map(data, \(x) broom::tidy(t.test(C_SinglePoint_mean ~ MassAnalyzerResolution, var.equal = FALSE, alternative = "two.sided", data = x))
    )) |>
  unnest(res) |> 
  ungroup() |> 
  select(SampleType, ceramideName, 'P value' = p.value)

d_srm_mean_mstype_stats_part2 <- d_srm_mean_mstype |> 
  group_by(SampleType, ceramideName) |>
  summarise(
    'n\n(LowRes)' = length(C_Adj_mean[MassAnalyzerResolution == "LowRes"]),
    'n\n(HighRes)' = length(C_Adj_mean[MassAnalyzerResolution == "HighRes"]),
    '\U003BCmol/L\n(LowRes)' = mean(C_Adj_mean[MassAnalyzerResolution == "LowRes"]),
    '\U003BCmol/L\n(HighRes)' = mean(C_Adj_mean[MassAnalyzerResolution == "HighRes"]),
    '%CV\n(LowRes)'= sd(C_Adj_mean[MassAnalyzerResolution == "LowRes"]) / mean(C_Adj_mean[MassAnalyzerResolution == "LowRes"]) * 100,
    '%CV\n(HighRes)' = sd(C_Adj_mean[MassAnalyzerResolution == "HighRes"])/ sd(C_Adj_mean[MassAnalyzerResolution == "HighRes"]) * 100)

d_srm_mean_mstype_stats <- d_srm_mean_mstype_stats_part2 |>  left_join(d_srm_mean_mstype_stats_part1)
write_excel_csv(d_srm_mean_mstype_stats, here("manuscript/output/Unpublished_Comparison_LowRes-vs-HighRes-MS_MultiPoint.csv"))


```


## 22c - Comparison SOP vs OTHER protocol types of single-point calibration derived concenctrations

Concentrations and inter-lab %CV of ceramide species from the two protocol types (SOP and OTHER). The concentrations given in µmol/L were obtained using the **single-point** calibration with outlier removed. The P values are from the comparison of individual values reported by SOP vs OTHER protocols (Welch’s two-sided t-test). N corresponds to the number of datasets after outlier removal. This table corresponds to Supplementary Table S2 that depicts the equivalent comparison for multi-point calibration derived concentrations.

```{r other-tables-comp-sop-other-sp}

# Concentrations (Single Point Calibration) and correspoding % CV of ceramide species from the two protocol types based on Single-Point Cal  ------

summary_tableS2B_sp_stats_part1 <- d_srm_mean_filt_sp |>
  group_by(ceramideName, SampleType) |>
  nest() |>
  mutate(res = purrr::map(data, \(x) broom::tidy(
    t.test(
      C_Adj_mean ~ Protocol,
      var.equal = FALSE,
      alternative = "two.sided",
      data = x )))) |>
  unnest(res) |>
  ungroup() |>
  select(SampleType, ceramideName, p.value)

summary_tableS2B_sp_stats_part2 <- d_srm_mean_filt_sp |>
  group_by(SampleType, ceramideName) |>
  summarise(
    n_SOP = length(C_SinglePoint_mean[Protocol == "SOP"]),
    n_OTHER = length(C_SinglePoint_mean[Protocol == "OTHER"]),
    mean_SOP = mean(C_SinglePoint_mean[Protocol == "SOP"]),
    mean_OTHER = mean(C_SinglePoint_mean[Protocol == "OTHER"]),
    CV_SOP = sd(C_SinglePoint_mean[Protocol == "SOP"]) / mean_SOP * 100,
    CV_OTHER = sd(C_SinglePoint_mean[Protocol == "OTHER"]) / mean_OTHER * 100
  )

summary_tableS2B_final <- summary_tableS2B_sp_stats_part2 |>
  left_join(summary_tableS2B_sp_stats_part1) |>
  select(
    Matrix = SampleType,
    Ceramide = ceramideName,
    'n\n(SOP)' = n_SOP,
    'n\n(OTHER)' = n_OTHER,
    '\U003BCmol/L\n(SOP)' = mean_SOP,
    '\U003BCmol/L\n(OTHER)' = mean_OTHER,
    'P value' = p.value,
    '%CV\n(SOP)' = CV_SOP,
    '%CV\n(OTHER)' = CV_OTHER
  )

write_excel_csv(
  x = summary_tableS2B_final,
  file = here("manuscript/output/Unpublished_Concentrations-CVs_SOP-vs-OTHER_SinglePoint.csv")
)
```

